<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
        }
        
        h1 {
            color: #4CAF50;
            margin: 0 0 20px 0;
            font-size: 18px;
        }
        
        .status {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .log {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <h1>üöÄ RapidTriage DevTools Panel</h1>
    
    <div class="status">
        <div>‚úÖ Panel loaded successfully!</div>
        <div>Time: <span id="time"></span></div>
        <div>Chrome: <span id="chrome-version"></span></div>
    </div>
    
    <button onclick="testServer()">Test Server</button>
    <button onclick="takeScreenshot()">Screenshot</button>
    <button onclick="clearLogs()">Clear</button>
    <button onclick="openDevTools()">Open DevTools</button>
    
    <br><br>
    
    <button onclick="runLighthouseAudit()">Lighthouse Audit</button>
    <button onclick="getConsoleLogs()">Console Logs</button>
    <button onclick="inspectElement()">Inspect Element</button>
    
    <div id="logs"></div>
    
    <script>
        // Initialize
        document.getElementById('time').textContent = new Date().toLocaleString();
        
        const chromeVersion = navigator.userAgent.match(/Chrome\/(\d+)/);
        document.getElementById('chrome-version').textContent = chromeVersion ? chromeVersion[1] : 'Unknown';
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.insertBefore(logDiv, logs.firstChild);
        }
        
        function testServer() {
            addLog('Testing server connection...');
            fetch('http://localhost:3025/.identity')
                .then(response => response.json())
                .then(data => {
                    addLog(`‚úÖ Connected: ${data.name} v${data.version}`);
                })
                .catch(error => {
                    addLog(`‚ùå Connection failed: ${error.message}`);
                });
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('Logs cleared');
        }
        
        function takeScreenshot() {
            addLog('üì∑ Taking screenshot...');
            
            // For DevTools panel, we need to use the inspected window
            const tabId = chrome.devtools.inspectedWindow.tabId;
            
            chrome.runtime.sendMessage({
                type: 'CAPTURE_SCREENSHOT',
                tabId: tabId
            }, function(response) {
                if (chrome.runtime.lastError) {
                    addLog(`‚ùå Screenshot failed: ${chrome.runtime.lastError.message}`);
                } else if (response && response.success) {
                    addLog('‚úÖ Screenshot captured and sent to server');
                    addLog(`üìÅ Saved as: ${response.path || 'screenshot.png'}`);
                } else {
                    addLog(`‚ùå Screenshot failed: ${response?.error || 'Unknown error'}`);
                }
            });
        }
        
        function openDevTools() {
            addLog('Opening DevTools...');
            chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                chrome.debugger.attach({tabId: tabs[0].id}, '1.0', function() {
                    if (chrome.runtime.lastError) {
                        addLog(`‚ùå DevTools failed: ${chrome.runtime.lastError.message}`);
                    } else {
                        addLog('‚úÖ DevTools opened (press F12 to see)');
                    }
                });
            });
        }
        
        function runLighthouseAudit() {
            addLog('üîç Starting Lighthouse audit...');
            
            // Get URL from inspected window
            const currentUrl = chrome.devtools.inspectedWindow.location.href;
            addLog(`üìä Auditing: ${currentUrl}`);
            
            fetch('http://localhost:3025/api/lighthouse', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: currentUrl})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const scores = data.data.scores;
                    const metrics = data.data.metrics;
                    
                    addLog('‚úÖ Lighthouse Audit Complete:');
                    addLog(`  üèÉ Performance: ${scores.performance}/100`);
                    addLog(`  ‚ôø Accessibility: ${scores.accessibility}/100`);
                    addLog(`  üéØ Best Practices: ${scores.bestPractices}/100`);
                    addLog(`  üîç SEO: ${scores.seo}/100`);
                    addLog(`  ‚è±Ô∏è Load Time: ${metrics.loadTime}ms`);
                } else {
                    addLog(`‚ùå Lighthouse failed: ${data.error}`);
                }
            })
            .catch(error => {
                addLog(`‚ùå Lighthouse error: ${error.message}`);
            });
        }
        
        function getConsoleLogs() {
            addLog('üìã Getting console logs...');
            
            // Get URL from inspected window
            const currentUrl = chrome.devtools.inspectedWindow.location.href;
            addLog(`üîç Analyzing console logs for: ${currentUrl}`);
            
            fetch('http://localhost:3025/api/console-logs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: currentUrl})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const logs = data.data.logs;
                    addLog(`‚úÖ Found ${logs.length} console entries:`);
                    
                    if (logs.length === 0) {
                        addLog('  üìù No console messages found');
                    } else {
                        // Group by log level
                        const byLevel = logs.reduce((acc, log) => {
                            acc[log.level] = (acc[log.level] || 0) + 1;
                            return acc;
                        }, {});
                        
                        Object.entries(byLevel).forEach(([level, count]) => {
                            const emoji = level === 'error' ? '‚ùå' : level === 'warn' ? '‚ö†Ô∏è' : level === 'info' ? '‚ÑπÔ∏è' : 'üìù';
                            addLog(`  ${emoji} ${level}: ${count} messages`);
                        });
                        
                        // Show last few messages
                        addLog('  üìÉ Recent messages:');
                        logs.slice(-5).forEach(log => {
                            const emoji = log.level === 'error' ? '‚ùå' : log.level === 'warn' ? '‚ö†Ô∏è' : 'üìù';
                            addLog(`    ${emoji} ${log.text.substring(0, 60)}${log.text.length > 60 ? '...' : ''}`);
                        });
                    }
                } else {
                    addLog(`‚ùå Console logs failed: ${data.error}`);
                }
            })
            .catch(error => {
                addLog(`‚ùå Console logs error: ${error.message}`);
            });
        }
        
        function inspectElement() {
            addLog('Element inspection ready - select an element on the page');
            chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
                addLog('üí° Click on any element on the page to inspect it');
            });
        }
        
        // Initial log
        addLog('RapidTriage panel initialized');
        
        // Auto test server
        setTimeout(testServer, 500);
    </script>
</body>
</html>